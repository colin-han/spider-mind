# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## é¡¹ç›®æ¶æ„

Spider Mind æ˜¯ä¸€ä¸ªAIè¾…åŠ©æ€ç»´å¯¼å›¾å·¥å…·ï¼Œä½¿ç”¨Next.js 14 + TypeScriptå…¨æ ˆå¼€å‘ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **å‰ç«¯**: React 18 + TypeScript + Tailwind CSS + Shadcn/ui + ReactFlow
- **åç«¯**: Next.js 14 App Router + API Routes  
- **æ•°æ®åº“**: Supabase (PostgreSQL + pgvectoræ‰©å±•)
- **AIé›†æˆ**: Claude 3.5 Sonnet + OpenAI Embeddings (text-embedding-3-small)
- **çŠ¶æ€ç®¡ç†**: Zustand + ReactFlowå†…ç½®çŠ¶æ€

### å¼€å‘å‘½ä»¤

é¡¹ç›®ä½¿ç”¨PM2è¿›è¡Œç»Ÿä¸€çš„æœåŠ¡ç®¡ç†ï¼ŒåŒ…æ‹¬Next.jsæœåŠ¡å™¨å’ŒPostgreSQLæ•°æ®åº“ï¼š

```bash
# ğŸš€ å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ (æ•°æ®åº“ + Next.jså¼€å‘æœåŠ¡å™¨)
node scripts/pm2-manager.js dev

# ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ (æ•°æ®åº“ + Next.jsç”Ÿäº§æœåŠ¡å™¨)  
node scripts/pm2-manager.js prod

# ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡
node scripts/pm2-manager.js stop

# ğŸ“Š æœåŠ¡çŠ¶æ€ç®¡ç†
npm run pm2:status      # æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
npm run pm2:logs        # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
npm run pm2:monit       # æ‰“å¼€PM2ç›‘æ§é¢æ¿
npm run pm2:restart     # é‡å¯æ‰€æœ‰æœåŠ¡
npm run pm2:reload      # æ— å®•æœºé‡è½½æœåŠ¡

# ğŸ”¨ æ„å»ºå’Œä»£ç æ£€æŸ¥
npm run build           # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run lint            # ESLintä»£ç æ£€æŸ¥
npm run format:check    # Prettieræ ¼å¼æ£€æŸ¥
npm run format:fix      # è‡ªåŠ¨ä¿®å¤æ ¼å¼é—®é¢˜
```

### æµ‹è¯•å‘½ä»¤

```bash
# ğŸ§ª BDDç«¯åˆ°ç«¯æµ‹è¯• (æ¨èç”¨äºåŠŸèƒ½éªŒè¯)
npm run test:bdd        # è¿è¡Œæ‰€æœ‰BDDæµ‹è¯•
npm run test:bdd:watch  # ç›‘å¬æ¨¡å¼è¿è¡ŒBDDæµ‹è¯•  
npm run test:bdd:html   # ç”ŸæˆHTMLæµ‹è¯•æŠ¥å‘Š

# ğŸ”¬ å•å…ƒæµ‹è¯• (Vitest)
npm run test            # ç›‘å¬æ¨¡å¼è¿è¡Œå•å…ƒæµ‹è¯•
npm run test:run        # å•æ¬¡è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
npm run test:coverage   # è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:ui         # æ‰“å¼€Vitest UIç•Œé¢
```

**é‡è¦è¯´æ˜**ï¼š
- å¼€å‘å’Œæµ‹è¯•æ—¶ç»Ÿä¸€ä½¿ç”¨PM2å‘½ä»¤ç®¡ç†æœåŠ¡ï¼Œç¡®ä¿æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å™¨åŒæ­¥å¯åŠ¨
- BDDæµ‹è¯•éœ€è¦å®Œæ•´çš„å¼€å‘ç¯å¢ƒè¿è¡Œï¼Œè¯·å…ˆæ‰§è¡Œ `node scripts/pm2-manager.js dev`
- PM2ä¼šè‡ªåŠ¨ç®¡ç†æ—¥å¿—æ–‡ä»¶ï¼Œä½äº `./logs/` ç›®å½•

### ç¯å¢ƒé…ç½®

é¡¹ç›®ä¾èµ–ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼ˆå‚è€ƒ `.env.local.example`ï¼‰ï¼š

```env
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# AI æœåŠ¡é…ç½®
OPENAI_API_KEY=your_openai_api_key  
ANTHROPIC_API_KEY=your_anthropic_api_key

# åº”ç”¨é…ç½®
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

## æ ¸å¿ƒæ¶æ„æ¨¡å—

### AIæœåŠ¡æ¶æ„ (`src/lib/ai.ts`)
- **ClaudeService**: å¤„ç†Claude APIè°ƒç”¨ï¼Œä¸“é—¨ä¼˜åŒ–æ€ç»´å¯¼å›¾åœºæ™¯
- **OpenAIService**: å¤„ç†OpenAI embeddingsç”Ÿæˆï¼Œæ”¯æŒå•ä¸ªå’Œæ‰¹é‡å¤„ç†  
- **AIService**: ç»¼åˆAIæœåŠ¡ï¼Œå¤„ç†æ€ç»´å¯¼å›¾å†…å®¹å‘é‡åŒ–å’Œæœç´¢æŸ¥è¯¢

AIè¯·æ±‚é€šè¿‡ä»¥ä¸‹APIè·¯ç”±å¤„ç†ï¼š
- `/api/ai/mindmap` - æ€ç»´å¯¼å›¾AIåŠ©æ‰‹åŠŸèƒ½
- `/api/ai/embeddings` - å‘é‡åµŒå…¥ç”Ÿæˆ  
- `/api/search` - è¯­ä¹‰æœç´¢åŠŸèƒ½

### æ•°æ®åº“æ¶æ„ (`src/lib/database.ts`)
åŸºäºSupabaseçš„æœåŠ¡ç±»æ¶æ„ï¼š
- **MindMapService**: æ€ç»´å¯¼å›¾CRUDæ“ä½œå’Œå‘é‡æœç´¢
- **ProfileService**: ç”¨æˆ·é…ç½®ç®¡ç†
- **AuthService**: è®¤è¯å’Œä¼šè¯ç®¡ç†

æ•°æ®åº“ä½¿ç”¨pgvectoræ‰©å±•æ”¯æŒå‘é‡æœç´¢ï¼Œä¸»è¦è¡¨ç»“æ„ï¼š
- `profiles` - ç”¨æˆ·é…ç½®  
- `mind_maps` - æ€ç»´å¯¼å›¾ä¸»è¡¨ï¼ˆåŒ…å«embeddingåˆ—ï¼‰
- `mind_map_nodes` - èŠ‚ç‚¹è¯¦ç»†è¡¨ï¼ˆæ”¯æŒèŠ‚ç‚¹çº§å‘é‡æœç´¢ï¼‰

### æ€ç»´å¯¼å›¾ç»„ä»¶æ¶æ„ (`src/components/mind-map/`)
åŸºäºReactFlowæ„å»ºçš„æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨ï¼š
- **MindMap**: ä¸»å®¹å™¨ç»„ä»¶ï¼Œç®¡ç†nodes/edgesçŠ¶æ€å’ŒAIé›†æˆ
- **MindMapNode**: è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶ï¼Œæ”¯æŒåŒå‡»ç¼–è¾‘å’Œå¤šè¿æ¥ç‚¹
- **MindMapToolbar**: å·¥å…·æ ï¼ŒåŒ…å«åŸºæœ¬æ“ä½œå’ŒAIåŠ©æ‰‹å…¥å£
- **AIAssistant** (`src/components/ai/`): AIåŠ©æ‰‹é¢æ¿ï¼Œæ”¯æŒèŠ‚ç‚¹æ‰©å±•ã€æ™ºèƒ½å»ºè®®ã€ç»“æ„åˆ†æ

## é‡è¦å¼€å‘æ³¨æ„äº‹é¡¹

### AIåŠŸèƒ½é›†æˆ
- AIæœåŠ¡è°ƒç”¨éƒ½åœ¨æœåŠ¡ç«¯è¿›è¡Œï¼Œå‰ç«¯é€šè¿‡APIè·¯ç”±è°ƒç”¨
- Claudeç”¨äºå†…å®¹ç”Ÿæˆå’Œåˆ†æï¼ŒOpenAIç”¨äºå‘é‡åµŒå…¥
- AIå»ºè®®ä»¥JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«typeã€titleã€descriptionã€contentç­‰å­—æ®µ

### æ€ç»´å¯¼å›¾èŠ‚ç‚¹ç®¡ç†
- èŠ‚ç‚¹ä½¿ç”¨UUIDä½œä¸ºç»Ÿä¸€IDï¼ŒåŒæ—¶ç”¨ä½œReactFlowèŠ‚ç‚¹IDå’Œæ•°æ®åº“ä¸»é”®
- èŠ‚ç‚¹æ•°æ®å­˜å‚¨åœ¨ReactFlowçš„`data`å±æ€§ä¸­ï¼ŒåŒ…å«`content`å’Œ`isEditing`
- èŠ‚ç‚¹ç¼–è¾‘é€šè¿‡è‡ªå®šä¹‰äº‹ä»¶(`nodeContentUpdate`)åœ¨ç»„ä»¶é—´é€šä¿¡
- æ”¯æŒæ ‘å½¢ç»“æ„ï¼š`parent_node_id`å»ºç«‹çˆ¶å­å…³ç³»ï¼Œ`sort_order`æ§åˆ¶åŒçº§æ’åºï¼Œ`node_level`è¡¨ç¤ºå±‚çº§
- ä¸ºè‡ªåŠ¨å¸ƒå±€ç®—æ³•æä¾›å®Œæ•´çš„ç»“æ„åŒ–æ•°æ®æ”¯æŒ

### æ•°æ®åº“å‘é‡æœç´¢
- ä½¿ç”¨pgvectorçš„ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢(`<=>`)
- é»˜è®¤ç›¸ä¼¼åº¦é˜ˆå€¼0.78ï¼Œå¯é€šè¿‡å‚æ•°è°ƒæ•´  
- æœç´¢å‡½æ•°ï¼š`search_mind_maps_by_similarity()` å’Œ `search_nodes_by_similarity()`

### ç±»å‹å®‰å…¨
- ä¸¥æ ¼çš„TypeScripté…ç½®ï¼Œç¦ç”¨`any`ç±»å‹
- Supabaseç±»å‹å®šä¹‰åœ¨`src/lib/supabase.ts`ä¸­ç»´æŠ¤
- AIç›¸å…³æ¥å£å®šä¹‰åœ¨`src/lib/ai.ts`é¡¶éƒ¨

### æ„å»ºæ³¨æ„äº‹é¡¹
- ä½¿ç”¨å ä½ç¬¦é¿å…æ„å»ºæ—¶ç¯å¢ƒå˜é‡ç¼ºå¤±æŠ¥é”™
- APIè·¯ç”±éœ€è¦é€‚å½“çš„é”™è¯¯å¤„ç†é˜²æ­¢æ„å»ºå¤±è´¥
- ReactFlowéœ€è¦å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œç»„ä»¶é¡¶éƒ¨éœ€è¦`'use client'`

### æ•°æ®åº“è¿ç§»
æ•°æ®åº“schemaä½äº`supabase/migrations/001_initial_schema.sql`ï¼ŒåŒ…å«ï¼š
- å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰
- pgvectorç´¢å¼•ä¼˜åŒ–
- è¡Œçº§å®‰å…¨ç­–ç•¥(RLS)
- è‡ªåŠ¨æ›´æ–°è§¦å‘å™¨
- å‘é‡æœç´¢å‡½æ•°

## å¼€å‘åŸåˆ™

### æ ¸å¿ƒåŸåˆ™
1. **éœ€æ±‚é©±åŠ¨å¼€å‘**: åœ¨æ²¡æœ‰æ”¶åˆ°æ˜ç¡®éœ€æ±‚ä¹‹å‰ï¼Œä¸è¦çŒœæµ‹ã€è¿‡åº¦è®¾è®¡æˆ–å¼•å…¥ä¸å¿…è¦çš„åŠŸèƒ½
2. **MVPä¼˜å…ˆ**: åœ¨MVP0å®ç°ä¹‹å‰ï¼Œä¸éœ€è¦è®°å½•æ•°æ®åº“migrationï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½å®ç°
3. **ç®€æ´æ¶æ„**: åœ¨ç¡®ä¿æ¶æ„æ¸…æ™°æ˜ç¡®çš„å‰æä¸‹ï¼Œå°½å¯èƒ½é¿å…å¼•å…¥è¿‡åº¦è®¾è®¡å¯¼è‡´ä»£ç å¤æ‚åŒ–

### å®æ–½æŒ‡å¯¼
- ä¼˜å…ˆå®ç°ç”¨æˆ·æ˜ç¡®è¦æ±‚çš„åŠŸèƒ½
- é¿å…æå‰ä¼˜åŒ–å’Œè¿‡åº¦æŠ½è±¡
- ä¿æŒä»£ç ç®€æ´å¯è¯»ï¼Œæ¶æ„æ¸…æ™°
- é‡æ„æ—¶è€ƒè™‘å®é™…éœ€æ±‚è€Œéç†è®ºå®Œç¾
- æ‰€æœ‰çš„BDDæµ‹è¯•éƒ½åº”è¯¥æ˜¯E2Eçš„ï¼Œä¸è¦ä½¿ç”¨Mock
- å¦‚æœè¦åœ¨å•å…ƒæµ‹è¯•æˆ–BDDæµ‹è¯•ä¸­ä½¿ç”¨mockæŠ€æœ¯ï¼Œéœ€è¦è·å¾—æ˜ç¡®çš„æˆæƒååœ¨ä½¿ç”¨

### å¼€å‘æµç¨‹æŒ‡å¯¼
- **ç¯å¢ƒå¯åŠ¨**: å§‹ç»ˆä½¿ç”¨ `node scripts/pm2-manager.js dev` å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ
- **åŠŸèƒ½å¼€å‘**: ä»£ç ä¿®æ”¹åï¼ŒPM2ä¼šè‡ªåŠ¨çƒ­é‡è½½ï¼Œæ— éœ€æ‰‹åŠ¨é‡å¯
- **åŠŸèƒ½æµ‹è¯•**: ä½¿ç”¨ `npm run test:bdd` è¿›è¡Œç«¯åˆ°ç«¯éªŒè¯  
- **ä»£ç è´¨é‡**: æäº¤å‰è¿è¡Œ `npm run lint` å’Œ `npm run format:check`
- **æœåŠ¡ç›‘æ§**: ä½¿ç”¨ `npm run pm2:monit` ç›‘æ§æœåŠ¡æ€§èƒ½å’Œèµ„æºä½¿ç”¨
- **æ—¥å¿—è°ƒè¯•**: ä½¿ç”¨ `npm run pm2:logs` æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼Œæˆ–æŸ¥çœ‹ `./logs/` ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶