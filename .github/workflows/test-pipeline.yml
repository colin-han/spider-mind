name: ğŸ§ª ç»¼åˆæµ‹è¯•ç®¡é“

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥å‡Œæ™¨2ç‚¹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” ESLint æ£€æŸ¥
        run: npm run lint:check

      - name: ğŸ¨ Prettier æ ¼å¼æ£€æŸ¥
        run: npm run format:check

      - name: ğŸ”¬ TypeScript ç±»å‹æ£€æŸ¥
        run: npm run type-check

      - name: ğŸ“Š ç”Ÿæˆä»£ç è´¨é‡æŠ¥å‘Š
        run: |
          mkdir -p reports
          npm run lint:check -- --format json --output-file reports/eslint-report.json || true
          npm run type-check -- --noEmit false --outDir reports/tsc-output || true

      - name: ğŸ“¤ ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: reports/
          retention-days: 7

  # å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
  unit-integration-tests:
    name: ğŸ§ª å•å…ƒå’Œé›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        node-version: [18, 20, 21]
        test-suite: [unit, integration]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ§ª è¿è¡Œ ${{ matrix.test-suite }} æµ‹è¯•
        run: npm run test:${{ matrix.test-suite }} -- --coverage
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          mkdir -p test-results
          npm run test:${{ matrix.test-suite }} -- --coverage --reporter=junit --outputFile=test-results/${{ matrix.test-suite }}-results.xml

      - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}-node${{ matrix.node-version }}
          path: |
            test-results/
            coverage/
          retention-days: 7

      - name: ğŸ“ˆ ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        uses: codecov/codecov-action@v4
        if: matrix.node-version == '20' && matrix.test-suite == 'unit'
        with:
          files: ./coverage/lcov.info
          flags: ${{ matrix.test-suite }}
          name: ${{ matrix.test-suite }}-tests

  # E2E æµ‹è¯•
  e2e-tests:
    name: ğŸŒ ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1, 2, 3, 4]

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ å®‰è£… Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸŒ è¿è¡Œ E2E æµ‹è¯•
        run: |
          npx playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }}/4 \
            --reporter=junit \
            --output-dir=test-results/e2e-artifacts
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: ğŸ“¤ ä¸Šä¼  E2E æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-shard${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: ğŸ“¸ ä¸Šä¼ å¤±è´¥æˆªå›¾
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-failures-${{ matrix.browser }}-shard${{ matrix.shard }}
          path: test-results/e2e-artifacts/
          retention-days: 30

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: âš¡ æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf-test]')

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: npm run test:performance
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ“Š ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        if: always()
        run: |
          mkdir -p performance-results
          npm run test:performance -- --reporter=json --outputFile=performance-results/performance-report.json

      - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: performance-results/
          retention-days: 30

      - name: ğŸ“ˆ æ€§èƒ½å›å½’æ£€æŸ¥
        run: |
          # æ¯”è¾ƒæ€§èƒ½åŸºå‡†
          node scripts/check-performance-regression.js performance-results/performance-report.json

  # å®‰å…¨æµ‹è¯•
  security-tests:
    name: ğŸ”’ å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”’ è¿è¡Œå®‰å…¨æµ‹è¯•
        run: npm run test:security
        env:
          CI: true
          NODE_ENV: test

      - name: ğŸ” ä¾èµ–æ¼æ´æ‰«æ
        run: npm audit --audit-level high

      - name: ğŸ›¡ï¸ Semgrep å®‰å…¨æ‰«æ
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-10
            p/javascript
            p/typescript
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: ğŸ“Š ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        if: always()
        run: |
          mkdir -p security-results
          npm run test:security -- --reporter=json --outputFile=security-results/security-report.json

      - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-results
          path: security-results/
          retention-days: 30

  # å¯è®¿é—®æ€§æµ‹è¯•
  accessibility-tests:
    name: â™¿ å¯è®¿é—®æ€§æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ å®‰è£… Playwright
        run: npx playwright install chromium

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: npm run build

      - name: â™¿ è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•
        run: |
          # å¯åŠ¨åº”ç”¨
          npm start &
          APP_PID=$!

          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          npx wait-on http://localhost:3000 --timeout 30000

          # è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•
          npx axe-playwright --urls http://localhost:3000 \
            --save accessibility-results.json \
            --tags wcag2a,wcag2aa,wcag21aa

          # åœæ­¢åº”ç”¨
          kill $APP_PID

      - name: ğŸ“¤ ä¸Šä¼ å¯è®¿é—®æ€§æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: accessibility-results.json
          retention-days: 30

  # è§†è§‰å›å½’æµ‹è¯•
  visual-regression-tests:
    name: ğŸ‘ï¸ è§†è§‰å›å½’æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ å®‰è£… Playwright
        run: npx playwright install chromium

      - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
        run: npm run build

      - name: ğŸ‘ï¸ è¿è¡Œè§†è§‰å›å½’æµ‹è¯•
        run: |
          npx playwright test visual-regression/ \
            --update-snapshots=${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} \
            --reporter=html

      - name: ğŸ“¤ ä¸Šä¼ è§†è§‰å·®å¼‚æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # æµ‹è¯•ç»“æœèšåˆå’ŒæŠ¥å‘Š
  test-results:
    name: ğŸ“Š æµ‹è¯•ç»“æœèšåˆ
    runs-on: ubuntu-latest
    needs: [code-quality, unit-integration-tests, e2e-tests, security-tests]
    if: always()

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æµ‹è¯•æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: ğŸ“Š ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
        run: |
          mkdir -p final-report

          # åˆå¹¶æ‰€æœ‰æµ‹è¯•ç»“æœ
          find all-reports -name "*.xml" -exec cp {} final-report/ \;
          find all-reports -name "*.json" -exec cp {} final-report/ \;

          # ç”Ÿæˆ HTML æŠ¥å‘Š
          node scripts/generate-test-report.js final-report/

      - name: ğŸ“ˆ å‘å¸ƒæµ‹è¯•ç»“æœ
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: 'ğŸ§ª ç»¼åˆæµ‹è¯•ç»“æœ'
          path: 'final-report/*.xml'
          reporter: java-junit
          fail-on-error: false

      - name: ğŸ’¬ PRè¯„è®ºæµ‹è¯•ç»“æœ
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            const path = 'final-report/summary.json';

            if (fs.existsSync(path)) {
              const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
              const body = `## ğŸ§ª æµ‹è¯•ç»“æœæ‘˜è¦
              
              | æµ‹è¯•ç±»å‹ | é€šè¿‡ | å¤±è´¥ | è·³è¿‡ | æ€»è®¡ |
              |---------|------|------|------|------|
              | å•å…ƒæµ‹è¯• | ${summary.unit.passed} | ${summary.unit.failed} | ${summary.unit.skipped} | ${summary.unit.total} |
              | é›†æˆæµ‹è¯• | ${summary.integration.passed} | ${summary.integration.failed} | ${summary.integration.skipped} | ${summary.integration.total} |
              | E2Eæµ‹è¯• | ${summary.e2e.passed} | ${summary.e2e.failed} | ${summary.e2e.skipped} | ${summary.e2e.total} |
              | å®‰å…¨æµ‹è¯• | ${summary.security.passed} | ${summary.security.failed} | ${summary.security.skipped} | ${summary.security.total} |
              
              **ä»£ç è¦†ç›–ç‡**: ${summary.coverage}%
              **æ€»ä½“çŠ¶æ€**: ${summary.overall_status}
              
              è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [æµ‹è¯•æŠ¥å‘Š](${summary.report_url})
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: ğŸ“¤ ä¸Šä¼ æœ€ç»ˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-test-report
          path: final-report/
          retention-days: 30

  # æµ‹è¯•è´¨é‡ç›‘æ§
  test-quality:
    name: ğŸ“ˆ æµ‹è¯•è´¨é‡ç›‘æ§
    runs-on: ubuntu-latest
    needs: [test-results]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æµ‹è¯•æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: final-test-report
          path: reports

      - name: ğŸ“Š åˆ†ææµ‹è¯•è´¨é‡è¶‹åŠ¿
        run: |
          node scripts/analyze-test-quality.js reports/

      - name: ğŸ“ˆ æ›´æ–°è´¨é‡æŒ‡æ ‡
        env:
          MONITORING_API_KEY: ${{ secrets.MONITORING_API_KEY }}
        run: |
          # å‘é€æŒ‡æ ‡åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Datadog, New Relic ç­‰ï¼‰
          node scripts/send-test-metrics.js

# å·¥ä½œæµç¨‹é…ç½®
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# æƒé™é…ç½®
permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write
  security-events: write
